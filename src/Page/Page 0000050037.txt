OBJECT Page 50037 Envoi BC Mail Automatique
{
  OBJECT-PROPERTIES
  {
    Date=21/12/17;
    Time=11:24:41;
    Modified=Yes;
    Version List=JX-VSC3.0-PBD-JX-ABE;
  }
  PROPERTIES
  {
    InsertAllowed=No;
    DeleteAllowed=No;
    ModifyAllowed=No;
    SourceTable=Table2000000007;
    OnOpenPage=BEGIN
                 SETRANGE("Period Type","Period Type"::Date);
                 SETRANGE("Period Start",WORKDATE);

                 VSCSettings.GET;
                 {
                 IF ISCLEAR(PDFCreator) THEN
                   CREATE(PDFCreator,VSCSettings."New Server",VSCSettings."On Client");
                 IF ISCLEAR(PDFCreatorError) THEN
                   CREATE(PDFCreatorError,VSCSettings."New Server",VSCSettings."On Client");
                 }

                 ReportID := 50041;
                 IF Object.GET(Object.Type::Report,'',ReportID) THEN;

                 Gdate_DateCompta := TODAY;
                 IF NOT VSCSettings."Use Temporary Path" THEN
                  FileDirectory := VSCSettings."BC Path"
                 ELSE
                  FileDirectory := TEMPORARYPATH;

                 {
                 PDFCreatorError := PDFCreator.cError;

                 IF PDFCreator.cStart('/NoProcessingAtStartup',TRUE) = FALSE THEN
                      ERROR('Status: Error[' + FORMAT(PDFCreatorError.Number) + ']: ' + PDFCreatorError.Description);
                 }
               END;

    ActionList=ACTIONS
    {
      { 1000000002;  ;ActionContainer;
                      ActionContainerType=ActionItems }
      { 1000000003;1 ;Action    ;
                      Name=Lancement des envois;
                      Promoted=Yes;
                      PromotedIsBig=Yes;
                      Image=SendEmailPDF;
                      PromotedCategory=Process;
                      OnAction=BEGIN
                                 //mail exp‚diteur
                                 IF Grec_UserSetup.GET(USERID) THEN
                                   Gtext_Mail := Grec_UserSetup."E-Mail";

                                 //Window.OPEN('processing');
                                 //WindowisOpen := FALSE;
                                 //IF FileName = '' THEN
                                   //ERROR('Please specify what the file should be saved as');
                                 Object.GET(Object.Type::Report,'',ReportID);

                                 Grec_PurchaseHeader.SETFILTER(Grec_PurchaseHeader."Document Type", FORMAT(Grec_PurchaseHeader."Document Type"::Order));
                                 Grec_PurchaseHeader.SETFILTER(Grec_PurchaseHeader."Posting Date", FORMAT(Gdate_DateCompta));
                                 //Grec_PurchaseHeader.SETFILTER(Grec_PurchaseHeader."Posting Date", FORMAT(TODAY));
                                 Grec_PurchaseHeader.SETFILTER(Grec_PurchaseHeader.Import, 'Oui');

                                 IF Grec_PurchaseHeader.FIND('-') THEN
                                 BEGIN
                                   REPEAT
                                     Grec_PurchaseHeader2.SETFILTER(Grec_PurchaseHeader2."No.",Grec_PurchaseHeader."No.") ;

                                     IF Grec_PurchaseHeader2.FIND('-') THEN
                                     BEGIN
                                       Gtext_NomPresta := '';
                                       Gtext_PrenomPresta := '';
                                       Gtext_DebutContrat := '';
                                       Gtext_FinContrat := '';

                                       Gtext_Fournisseur:= Grec_PurchaseHeader2."Import Vendor Email";
                                       IF Gtext_Fournisseur ='' THEN
                                         ERROR('L''email du fournisseur pour la commande ' + Grec_PurchaseHeader2."No." + ' n''est pas renseign‚');

                                       //recherche des information sur le contrat
                                       Grec_Contract.SETFILTER(Grec_Contract."Order No.", Grec_PurchaseHeader2."No.");
                                       IF Grec_Contract.FIND('-') THEN
                                       BEGIN

                                         Gtext_NomPresta := DELCHR(Grec_Contract."Nom prestataire", '=', '');
                                         Gtext_PrenomPresta :=  DELCHR(Grec_Contract."Pr‚nom prestataire", '=', '');
                                         Gtext_DebutContrat := FORMAT(Grec_Contract."Date of entry",0,'<Day,2><Month,2><Year>');
                                         Gtext_FinContrat := FORMAT(Grec_Contract."End date",0,'<Day,2><Month,2><Year>');
                                         // FORMAT(DATE2DMY(Gdate_DebutContrat,1)) + '' +
                                           //FORMAT(DATE2DMY(Gdate_DebutContrat,2)) + '' + FORMAT(DATE2DMY(Gdate_DebutContrat,3)) ;

                                         Name := STRSUBSTNO('%1- Prestation ' + Gtext_NomPresta + ' ' + Gtext_PrenomPresta
                                         + ' du ' + Gtext_DebutContrat + ' au ' + Gtext_FinContrat + '', Grec_PurchaseHeader2."No.");

                                         FileName := STRSUBSTNO('%1-Prestation_' + Gtext_NomPresta + '_' + Gtext_PrenomPresta
                                         + '_du_' + Gtext_DebutContrat + '_au_' + Gtext_FinContrat + '.pdf', Grec_PurchaseHeader2."No.");

                                       END ELSE
                                       BEGIN
                                         FileName := STRSUBSTNO('%1.pdf', Grec_PurchaseHeader2."No.");
                                         Name := STRSUBSTNO('%1', Grec_PurchaseHeader2."No.");
                                       END;

                                       ObjetMail := Name;
                                       Corps:= 'Madame, Monsieur,<br><br>';
                                       Corps += 'Vous trouverez en piŠce jointe le bon de commande concernant la prestation de ';
                                       Corps += Gtext_NomPresta + ' ' + Gtext_PrenomPresta + ' ';
                                       Corps += 'pour la p‚riode du ' + Gtext_DebutContrat + ' au ' + Gtext_FinContrat + '.<br><br>';
                                       Corps += '<u>Nous vous remercions de rappeler la r‚f‚rence des bons de commande sur vos factures.</u><br><br>';
                                       //JX-ABE Ajout du 21/12/2017
                                       Corps += 'Les factures sont … transmettre … cette adresse mail : Facturesonly@oui.sncf,<br><br>';
                                       //JX-ABE Fin d'ajout du 21/12/2017
                                       Corps += 'Nous vous en souhaitons bonne r‚ception et restons … votre disposition pour toutes questions compl‚mentaires.';
                                       Corps += '<br><br>';
                                       Corps += 'Cordialement,<br><br>';

                                       //JX-ABE Modif du 21/12/2017 : Changer la signature du corps

                                       // //JX-ABE Modif du 09/12/2016
                                       // //Corps += 'Le Service Contr“le de Gestion VSC-Technologies';
                                       // Corps += 'Le Service Contr“le de Gestion Voyages-Sncf.com';
                                       // //JX-ABE Fin Modif du 09/12/2016

                                       Corps += 'Le Service Contr“le de Gestion de OUI.Sncf';

                                       //JX-ABE Fin Modif du 21/12/2017


                                 { // Suppression du code PDFCreator suite migration Nav2015
                                       PDFCreatorOption :=  PDFCreator.cOptions;

                                       PDFCreatorOption.UseAutosave := 1;
                                       PDFCreatorOption.UseAutosaveDirectory := 1;
                                       PDFCreatorOption.AutosaveDirectory := FileDirectory;
                                       PDFCreatorOption.AutosaveFormat := 0;                       //PDF file, you can also save in other formats
                                       PDFCreatorOption.AutosaveFilename := FileName;

                                       PDFCreator.cOptions := PDFCreatorOption;
                                       PDFCreator.cClearCache();
                                       DefaultPrinter := PDFCreator.cDefaultPrinter;
                                       PDFCreator.cDefaultPrinter := 'PDFCreator';
                                       PDFCreator.cPrinterStop := FALSE;
                                 }

                                       REPORT.SAVEASPDF(ReportID,FileDirectory + FileName,Grec_PurchaseHeader2);
                                 //      SLEEP(8000);

                                       // JX-VSC3.0-PBD Nav2015
                                       IF VSCSettings."BC Test Mode" THEN
                                        SMAIL.CreateMessage('CDG VSC-Technologies',Gtext_Mail,VSCSettings."BC E-Mail Test",ObjetMail,'',TRUE)
                                       ELSE
                                       //
                                        SMAIL.CreateMessage('CDG VSC-Technologies',Gtext_Mail,Gtext_Fournisseur,ObjetMail,'',TRUE);
                                       SMAIL.AppendBody(Corps);
                                       SMAIL.AddAttachment(FileDirectory + FileName,FileName);
                                       SMAIL.Send;

                                       //On modifie la commande pour d‚cocher le champ "Import"
                                       // JX-VSC3.0-PBD Nav2015
                                       IF NOT VSCSettings."BC Test Mode" THEN
                                        IF Grec_PurchaseHeader3.GET(Grec_PurchaseHeader3."Document Type"::Order,Grec_PurchaseHeader2."No.") THEN BEGIN
                                         Grec_PurchaseHeader3.Import := FALSE;
                                         Grec_PurchaseHeader3.MODIFY;
                                         COMMIT;
                                        END;

                                       FILE.ERASE(FileDirectory+FileName);//on supprime le fichier aprŠs envoi

                                     END;
                                   UNTIL Grec_PurchaseHeader.NEXT = 0;
                                   MESSAGE('Les envois sont termin‚s');
                                 END ELSE
                                   ERROR('Aucune commande … la date indiqu‚e');
                               END;
                                }
    }
  }
  CONTROLS
  {
    { 1000000000;;Container;
                Name=Envoi BC Mail Automatique;
                ContainerType=ContentArea }

    { 1000000001;1;Field  ;
                Name=Gdate_DateCompta;
                CaptionML=FRA=Saisir la date de comptabilisation;
                SourceExpr=Gdate_DateCompta }

  }
  CODE
  {
    VAR
      FileDirectory@1000000028 : Text;
      FileName@1000000027 : Text;
      ReportID@1000000026 : Integer;
      VSCSettings@1000000031 : Record 50014;
      Object@1000000025 : Record 2000000001;
      PDFCreator@1000000024 : Automation "{ECF69623-0648-4FEF-BD17-5DE580007EFE} 1.0:{944DAF5E-2C6F-4C4D-94E6-E96A9EA32E4C}:Unknown Automation Server.Unknown Class" WITHEVENTS;
      PDFCreatorOption@1000000023 : Automation "{ECF69623-0648-4FEF-BD17-5DE580007EFE} 1.0:{10E0A9F1-E439-493F-8C35-41D98511EC5F}:Unknown Automation Server.Unknown Class";
      PDFCreatorError@1000000022 : Automation "{ECF69623-0648-4FEF-BD17-5DE580007EFE} 1.0:{A5C1B321-79E3-40BD-82ED-E7CE6D366901}:Unknown Automation Server.Unknown Class";
      DefaultPrinter@1000000021 : Text[200];
      Window@1000000020 : Dialog;
      WindowisOpen@1000000019 : Boolean;
      FileDialog@1000000018 : Codeunit 412;
      Grec_PurchaseHeader@1000000017 : Record 38;
      Tofile@1000000016 : Text;
      Grec_PurchaseHeader2@1000000015 : Record 38;
      SMAIL@1000000014 : Codeunit 400;
      Gtext_Mail@1000000013 : Text[50];
      Grec_UserSetup@1000000012 : Record 91;
      Gtext_Fournisseur@1000000011 : Text[250];
      Gtext_text@1000000010 : Text;
      Name@1000000009 : Text;
      ObjetMail@1000000008 : Text;
      Corps@1000000007 : Text;
      Gdate_DateCompta@1000000006 : Date;
      Grec_PurchaseHeader3@1000000005 : Record 38;
      Grec_Contract@1000000004 : Record 50008;
      Gtext_NomPresta@1000000003 : Text[100];
      Gtext_DebutContrat@1000000002 : Text[10];
      Gtext_FinContrat@1000000001 : Text[10];
      Gtext_PrenomPresta@1000000000 : Text[100];
      Gtext_CheminDossierBC@1000000030 : TextConst 'FRA=\\10.16.34.109\Pdf\Fournisseurs\';
      Gtext_CheminDossierBC1@1000000029 : TextConst 'FRA=C:\Users\aurelie\Desktop\temp\';

    EVENT PDFCreator@1000000024::eReady@1();
    BEGIN
    END;

    EVENT PDFCreator@1000000024::eError@2();
    BEGIN
    END;

    BEGIN
    {
      JX-ABE 09/12/2016 : Modification de la signature du corps
      JX-ABE 21/12/2017 : Changer la signature du corps.
      JX-ABE 21/12/2017 : Ajout le text demand‚.
    }
    END.
  }
}


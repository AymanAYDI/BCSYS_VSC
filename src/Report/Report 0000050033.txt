OBJECT Report 50033 Generate FNP semi-automatic
{
  OBJECT-PROPERTIES
  {
    Date=13/05/15;
    Time=12:00:00;
    Modified=Yes;
    Version List=JX-VSC1.2-XAD;
  }
  PROPERTIES
  {
    CaptionML=[ENU=Generate FNP semi-automatic;
               FRA=G‚n‚rer FNP semi-automatiques];
    ProcessingOnly=Yes;
  }
  DATASET
  {
    { 9309;    ;DataItem;LineOrder           ;
               DataItemTable=Table39;
               DataItemTableView=SORTING(Document Type,Document No.,Line No.);
               OnPreDataItem=BEGIN
                               //Compteur de ligne
                               Gint_Ligne := 0;

                               //Recherche de l'ann‚e comptable en cours
                               //D‚but MOFIF JX-XAD 27/04/2010
                               {
                               Grec_ParamCompa.RESET;
                               IF Grec_ParamCompa.FIND('-') THEN BEGIN
                                 Grec_ParamCompa.CALCFIELDS(Grec_ParamCompa."Posting Allowed From");
                                 Gdate_D‚butExerciceComptable := Grec_ParamCompa."Posting Allowed From";
                                 IF NOT EVALUATE(Gint_Ann‚eComptable,FORMAT(Gdate_D‚butExerciceComptable,4,'<Year,4>')) THEN
                                   EVALUATE(Gint_Ann‚eComptable,FORMAT(WORKDATE,4,'<Year,4>'));
                               END;
                               }
                               EVALUATE(Gint_Ann‚eComptable,FORMAT(WORKDATE,4,'<Year,4>'));
                               //Fin MOFIF JX-XAD 27/04/2010


                               //Initialisation du Nø document FNP
                               Grec_NoSeriesLine.SETFILTER(Grec_NoSeriesLine."Series Code",'%1','FNP-SA');
                               IF Grec_NoSeriesLine.FIND('-') THEN
                                 IF Grec_NoSeriesLine."Last No. Used" <> '' THEN
                                   Gcode_NoFNP := INCSTR(Grec_NoSeriesLine."Last No. Used")
                                 ELSE
                                   Gcode_NoFNP := Grec_NoSeriesLine."Starting No.";

                               //On ne prend que les devis et commandes
                               LineOrder.SETFILTER(LineOrder."Document Type",'%1|%2',LineOrder."Document Type"::Order,LineOrder."Document Type"::Quote);

                               //Initialisation de la table temporaire
                               Grec_TemporaryTable.LOCKTABLE;
                               Grec_TemporaryTable.DELETEALL;
                             END;

               OnAfterGetRecord=BEGIN
                                  //********************* Traitement des commandes non r‚ceptionn‚es et des demandes d'achat ***********************************

                                  Gdate_Document := 0D;
                                  IF (LineOrder."Document Type" = LineOrder."Document Type"::Order) AND (LineOrder."Qty. to Receive" <> 0) THEN
                                  BEGIN
                                    Gdec_MontantHT := LineOrder."Qty. to Receive" * "Direct Unit Cost";
                                    Gdec_MontantTTC := Gdec_MontantHT + (Gdec_MontantHT * "VAT %" / 100);
                                    IF Grec_PurchaseHeader.GET(LineOrder."Document Type"::Order,LineOrder."Document No.") THEN
                                      Gdate_Document := Grec_PurchaseHeader."Document Date";
                                  END ELSE IF (LineOrder."Document Type" = LineOrder."Document Type"::Quote)
                                              AND (LineOrder.Type <> LineOrder.Type::" ") AND (LineOrder."No." <> '')THEN
                                  BEGIN
                                    Gdec_MontantHT := LineOrder.Quantity * "Direct Unit Cost";
                                    Gdec_MontantTTC := Gdec_MontantHT + (Gdec_MontantHT * "VAT %" / 100);
                                    IF Grec_PurchaseHeader.GET(LineOrder."Document Type"::Quote,LineOrder."Document No.") THEN
                                      Gdate_Document := Grec_PurchaseHeader."Document Date";
                                  END ELSE
                                    CurrReport.SKIP;

                                    IF Grec_Fournisseur.GET("Buy-from Vendor No.") THEN BEGIN
                                      Gtext_Fournisseur := Grec_Fournisseur.Name;
                                      Gtext_Description := 'SA-'+PADSTR(Grec_Fournisseur.Name+'-'+Description,47)
                                    END ELSE BEGIN
                                      Gtext_Fournisseur := '';
                                      Gtext_Description := '';
                                    END;

                                    IF (Type = Type::Item) OR ((Type = Type::"G/L Account") AND (COPYSTR("Gen. Prod. Posting Group",1,1) = '6')) THEN
                                    BEGIN
                                      Gcode_CompteG‚n‚ral := '40800001';
                                      Gcode_CompteTVA := '44586100'
                                    END ELSE
                                      IF (Type = Type::"Fixed Asset") OR ((Type = Type::"G/L Account") AND (COPYSTR("Gen. Prod. Posting Group",1,1) = '2')) THEN
                                    BEGIN
                                      Gcode_CompteG‚n‚ral := '40840001';
                                      Gcode_CompteTVA := '44586400';
                                    END;
                                END;
                                 }

    { 4871;1   ;DataItem;LineCSV             ;
               DataItemTable=Table2000000026;
               DataItemTableView=SORTING(Number)
                                 WHERE(Number=FILTER(1..3));
               OnAfterGetRecord=BEGIN
                                  WITH LineOrder DO
                                  BEGIN

                                    CASE LineCSV.Number OF

                                    1 : BEGIN
                                          //***************** Insertion ligne CREDIT *****************
                                          Grec_TemporaryTable.INIT;
                                          Gint_Ligne += 10000;
                                          Grec_TemporaryTable."Line No." := Gint_Ligne;
                                          Grec_TemporaryTable."Document No." := Gcode_NoFNP;
                                          Grec_TemporaryTable."External document No." := PADSTR("Document No.",20);
                                          Grec_TemporaryTable."Account No." := Gcode_CompteG‚n‚ral;
                                          Grec_TemporaryTable."Posting date" := Gdate_Compta;
                                          Grec_TemporaryTable."Document date" := Gdate_Document;
                                          Grec_TemporaryTable."Credit amount" := Gdec_MontantTTC;
                                          Grec_TemporaryTable.Description := Gtext_Description;
                                          Grec_TemporaryTable."Vendor No." := "Buy-from Vendor No.";
                                          Grec_TemporaryTable."Vendor name" := Gtext_Fournisseur;
                                          Grec_TemporaryTable."VAT rates" := LineOrder."VAT %";
                                  //  Ins‚r‚rAnalytique();   Modification NAv 2015
                                          Grec_TemporaryTable."Dimension Set ID" := "Dimension Set ID";
                                          Grec_TemporaryTable.INSERT;
                                        END;

                                    2 : BEGIN
                                          //***************** Insertion ligne DEBIT *****************
                                          Grec_TemporaryTable.INIT;
                                          Gint_Ligne += 10000;
                                          Grec_TemporaryTable."Line No." := Gint_Ligne;
                                          Grec_TemporaryTable."Document No." := Gcode_NoFNP;
                                          Grec_TemporaryTable."External document No." := PADSTR("Document No.",20);
                                          Grec_TemporaryTable."Account No." := "Gen. Prod. Posting Group";
                                          Grec_TemporaryTable."Posting date" := Gdate_Compta;
                                          Grec_TemporaryTable."Document date" := Gdate_Document;
                                          Grec_TemporaryTable."Debit amount" := Gdec_MontantHT;
                                          Grec_TemporaryTable.Description := Gtext_Description;
                                          Grec_TemporaryTable."Vendor No." := "Buy-from Vendor No.";
                                          Grec_TemporaryTable."Vendor name" := Gtext_Fournisseur;
                                          Grec_TemporaryTable."VAT rates" := LineOrder."VAT %";
                                  //  Ins‚r‚rAnalytique();   Modification NAv 2015
                                          Grec_TemporaryTable."Dimension Set ID" := "Dimension Set ID";
                                          Grec_TemporaryTable.INSERT;
                                        END;

                                    3 : BEGIN
                                          //***************** Insertion ligne TVA si montant non nul *****************
                                          IF ((Gdec_MontantTTC-Gdec_MontantHT) <> 0) THEN
                                          BEGIN
                                            Grec_TemporaryTable.INIT;
                                            Gint_Ligne += 10000;
                                            Grec_TemporaryTable."Line No." := Gint_Ligne;
                                            Grec_TemporaryTable."Document No." := Gcode_NoFNP;
                                            Grec_TemporaryTable."External document No." := PADSTR("Document No.",20);
                                            Grec_TemporaryTable."Account No." := Gcode_CompteTVA;
                                            Grec_TemporaryTable."Posting date" := Gdate_Compta;
                                            Grec_TemporaryTable."Document date" := Gdate_Document;
                                            Grec_TemporaryTable."Debit amount" := Gdec_MontantTTC-Gdec_MontantHT;
                                            Grec_TemporaryTable.Description := Gtext_Description;
                                            Grec_TemporaryTable."Vendor No." := "Buy-from Vendor No.";
                                            Grec_TemporaryTable."Vendor name" := Gtext_Fournisseur;
                                            Grec_TemporaryTable."VAT rates" := LineOrder."VAT %";
                                  //  Ins‚r‚rAnalytique();   Modification NAv 2015
                                            Grec_TemporaryTable."Dimension Set ID" := "Dimension Set ID";
                                            Grec_TemporaryTable.INSERT;
                                          END ELSE BEGIN
                                            CurrReport.SKIP;
                                          END;
                                        END;
                                    END;

                                  END;
                                END;
                                 }

  }
  REQUESTPAGE
  {
    PROPERTIES
    {
    }
    CONTROLS
    {
    }
  }
  LABELS
  {
  }
  CODE
  {
    VAR
      Gdec_MontantHT@1000000000 : Decimal;
      Gdec_MontantTTC@1000000001 : Decimal;
      "Gcode_CompteG‚n‚ral"@1000000002 : Code[20];
      Gcode_CompteTVA@1000000003 : Code[20];
      Gint_Ligne@1000000004 : Integer;
      Grec_NoSeriesLine@1000000005 : Record 309;
      Gcode_NoFNP@1000000006 : Code[20];
      Gcode_ExternalDoc@1000000007 : Code[20];
      Grec_TemporaryTable@1000000008 : Record 50005;
      Gdate_Compta@1000000009 : Date;
      Gdate_Document@1000000010 : Date;
      Grec_PurchaseHeader@1000000011 : Record 38;
      Gtext_Description@1000000012 : Text[50];
      Grec_Fournisseur@1000000013 : Record 23;
      Grec_Dimension@1000000014 : Record 348;
      Gopt_DocumentType@1000000016 : 'Quote,Order,Invoice,Credit Memo,Blanket Order,Return Order';
      Grec_ParamCompa@1000000017 : Record 98;
      "Gdate_D‚butExerciceComptable"@1000000018 : Date;
      "Gint_Ann‚eComptable"@1000000019 : Integer;
      "Gint_Ann‚eDocument"@1000000020 : Integer;
      Gtext_Fournisseur@1000000021 : Text[50];

    BEGIN
    {
      ------------------------------------- JX-VSC1.2 -------------------------------------
      CREATION JX-XAD 10/11/2009
      G‚n‚ration des FNP semi-automatiques
      Cr‚ation d'un fichier au format csv contenant la liste de :
      - toutes les commandes en cours non r‚ceptionn‚es
      - toutes les demandes d'achat
      Ce report a pour objectif de g‚n‚rer les donn‚es dans une table temporaire
      Un dataport se chargera des g‚n‚rer toutes les donn‚es dans un fichier Excel (format csv)

      MOFIF JX-XAD 27/04/2010
      Modification concernant le traitement de l'axe analytique PERIODE
    }
    END.
  }
  RDLDATA
  {
  }
}

